"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("gm"),e=require("path"),s=require("fs-extra"),i=require("stream");function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var a=r(t),n=r(e),o=r(s);const h={quality:0,format:"png",width:768,height:512,density:300,units:"PixelsPerInch",savePath:"./",saveFilename:"untitled",compression:"jpeg",rotation:0,depth:()=>32,contrast:-100,dither:!0,colors:2,colorspace:"GRAY",fuzz:25,opaque:"#373737"};class u{constructor(){this.quality=0,this.format="png",this.width=768,this.height=512,this.density=300,this.units="PixelsPerInch",this.savePath="./",this.saveFilename="untitled",this.compression="jpeg",this.depth=()=>32,this.contrast=-100,this.rotation=0,this.dither=!0,this.colors=2,this.colorspace="GRAY",this.fuzz=25,this.opaque="#373737",this.gm=a.default.subClass({imageMagick:!1})}generateValidFilename(t){return"number"==typeof t?`${this.savePath}/${this.saveFilename}.${t+1}.${this.format}`:`${this.savePath}/${this.saveFilename}.${this.format}`}gmBaseCommand(t,e){return this.gm(t,e).density(this.density,this.density).units(this.units).resize(this.width,this.height,"!").quality(this.quality).compress(this.compression).depth(this.depth).rotate("white",this.rotation).contrast(this.contrast).dither(this.dither).colors(this.colors).colorspace(this.colorspace).fuzz(this.fuzz,!0).opaque(this.opaque)}toBase64(t,e){const s=`${t.path}[${e}]`;return new Promise(((i,r)=>{this.gmBaseCommand(t,s).stream(this.format,((t,s)=>{let a="";if(t)return r(t);s.on("data",(t=>{a+=t.toString("binary")})).on("end",(()=>{const t=Buffer.from(a,"binary").toString("base64");return i({base64:t,size:`${this.width}x${this.height}`,page:e+1})}))}))}))}writeImage(t,e){const s=this.generateValidFilename(e),i=`${t.path}[${e}]`;return new Promise(((r,a)=>{this.gmBaseCommand(t,i).write(s,(t=>t?a(t):r({name:n.default.basename(s),size:`${this.width}x${this.height}`,fileSize:o.default.statSync(s).size/1e3,path:s,page:e+1})))}))}identify(t,e){const s=this.gm(t);return new Promise(((t,i)=>{e?s.identify(e,((e,s)=>e?i(e):t(s.replace(/^[\w\W]*?1/,"1")))):s.identify(((e,s)=>e?i(e):t(s)))}))}setQuality(t){return this.quality=t,this}setFormat(t){return this.format=t,this}setSize(t,e){return this.width=t,this.height=e||t,this}setDensity(t){return this.density=t,this}setRotation(t){return this.rotation=t,this}setUnits(t){return this.units=t,this}setSavePath(t){return this.savePath=t,this}setSaveFilename(t){return this.saveFilename=t,this}setCompression(t){return this.compression=t,this}setDepth(t){return this.depth=t,this}setContrast(t){return this.contrast=t,this}setDither(t){return this.dither=t,this}setColors(t){return this.colors=t,this}setColorspace(t){return this.colorspace=t,this}setFuzz(t){return this.fuzz=t,this}setOpaque(t){return this.opaque=t,this}setGMClass(t){return"boolean"==typeof t?(this.gm=a.default.subClass({imageMagick:t}),this):"imagemagick"===t.toLocaleLowerCase()?(this.gm=a.default.subClass({imageMagick:!0}),this):(this.gm=a.default.subClass({appPath:t}),this)}getOptions(){return{quality:this.quality,format:this.format,width:this.width,height:this.height,density:this.density,units:this.units,savePath:this.savePath,saveFilename:this.saveFilename,compression:this.compression,rotation:this.rotation,depth:this.depth,contrast:this.contrast,dither:this.dither,colors:this.colors,colorspace:this.colorspace,fuzz:this.fuzz,opaque:this.opaque}}}function c(t){return new i.Readable({read(){this.push(t),this.push(null)}})}function l(t,e){if("buffer"===t)return c(e);if("path"===t)return s.createReadStream(e);if("base64"===t)return i=e,c(Buffer.from(i,"base64"));var i;throw new Error("Cannot recognize specified source")}function m(t,e,s,i){return new(s||(s=Promise))((function(r,a){function n(t){try{h(i.next(t))}catch(t){a(t)}}function o(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(n,o)}h((i=i.apply(t,e||[])).next())}))}function f(t,e,s,i=1,r=!1){return m(this,void 0,void 0,(function*(){if(-1!==i&&i<1)throw new Error("Page number should be more than or equal 1");const a=l(e,s),n=l(e,s),o=Array.isArray(i)?i:[i],h=(i=-1===i?yield function(t,e){return m(this,void 0,void 0,(function*(){return(yield t.identify(e,"%p ")).split(" ").map((t=>parseInt(t,10)))}))}(t,n):o).map((e=>{if(i<1)throw new Error("Page number should be more than or equal 1");return r?t.toBase64(a,e-1):t.writeImage(a,e-1)}));return Promise.all(h)}))}function p(t,e,s=h){const i=new u;s=Object.assign(Object.assign({},h),s);const r=(s=1,r=!1)=>{if(s<1)throw new Error("Page number should be more than or equal 1");const a=l(t,e);return r?i.toBase64(a,s-1):i.writeImage(a,s-1)};return r.bulk=(s,r=!1)=>f(i,t,e,s,r),r.setOptions=()=>function(t,e){t.setQuality(e.quality).setFormat(e.format).setSize(e.width,e.height).setDensity(e.density).setUnits(e.units).setSavePath(e.savePath).setSaveFilename(e.saveFilename).setCompression(e.compression).setRotation(e.rotation).setDepth(e.depth).setContrast(e.contrast).setDither(e.dither).setColors(e.colors).setColorspace(e.colorspace).setFuzz(e.fuzz).setOpaque(e.opaque)}(i,s),r.setGMClass=t=>{i.setGMClass(t)},r.setOptions(),r}exports.fromBase64=function(t,e=h){return p("base64",t,e)},exports.fromBuffer=function(t,e=h){return p("buffer",t,e)},exports.fromPath=function(t,e=h){return p("path",t,e)};
